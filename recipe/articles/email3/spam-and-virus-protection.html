<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><!-- InstanceBegin template="../../../Templates/jimmyg.dwt" codeOutsideHTMLIsLocked="false" -->
<head>
<!-- InstanceBeginEditable name="doctitle" --><title>Spam and Virus Protection</title><!-- InstanceEndEditable --> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<!-- InstanceBeginEditable name="meta" -->
<meta name="description" content="3aims Web Development, a Knowledge Interaction Technology consultancy based in London and specialising in Python" />
<meta name="keywords" content="3aims Python Pylons Web Development Programming NHS Consultancy Database" />
<!--  InstanceEndEditable -->
<!-- InstanceBeginEditable name="head" --><!--  InstanceEndEditable -->
<style type="text/css">
html, body, div, p { margin: 0; padding: 0; border: 0; }
body { background: #213502; font-family: Arial, Georgia, serif; color: #333; font-size: 14px; line-height: 145%; }
.main { /* margin:0 auto; */ width: 90%; }
.dp20,
.dp25,
.dp33,
.dp40,
.dp50,
.dp75,
.dp80,
.dp100{float:left; display: inline; *margin-left:-0.04em; } /* IE margin hack */
.dp20{width:20%;}
.dp25{width:25%;}
.dp33{width:33.33%;}
.dp40{width:40%;}
.dp50{width:50%;}
.dp80{width:80%;}
.dp75{width:75%;}
.dp100{width:100%;}
.clear{ clear:both; overflow: auto; width: 100%; }
.noborder{border: 0px;}
#logobar { height: 68px; padding-top: 16px; padding-left: 20px; }
#links { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; padding-top: 49px; }
#links a:link, #links a:visited, #links a:hover { color: #fff; text-decoration: none; }
#links a:hover { color: #fff; text-decoration: underline; }
#footer a:link, #footer a:visited, #footer a:hover { color: #fff; text-decoration: underline; }
#footer p { color: #fff }
#search { text-align: right; }
#search form { padding-top: 15px; margin: 0px; }

#content { background: #fff; margin-top: 5px; margin-bottom: 10px;}
#content_content { padding: 20px; padding-right: 40px; }

#navcontainer ul { margin: 0; padding: 0; list-style-type: none; } 
#navcontainer ul li { display: inline; }
#navcontainer ul li a { text-decoration: none; padding: .2em .55em; }
#navcontainer ul li.first a { padding: .2em .55em .2em 0; }
#navcontainer ul li.highlight a { color: #fcff02; background: #008cca; }
h1 { font-family: Arial, serif; font-weight: normal; font-size: 26px; }
h2 { font-weight: normal; font-size: 22px;}
p { color: #333; }
li.norm { color: #333; }
p.large { font-size: 16px; }
p { padding-top: 15px; }
p.first { padding-top: 0px; }
li.norm a, li.norm a:visited, li.norm a:link, p a, p a:visited, p a:link { color: #3883a9 ; }
p a:hover { color: #58aecb; }

pre { overflow:auto; border-top: 1px solid #71ae1b; border-bottom: 1px solid #71ae1b; background: #e0f8bf; padding: 3px; font-size: 13px; margin-bottom: 0px; line-height: 130%; }
table { margin-top: 15px; }
#linksbar { background: #71ae1b;  border-bottom: 1px solid #9ddb44; border-top: 3px solid #142200; padding: 13px 0 13px 0; }
#linksbar h2 { padding: 0px; margin: 0px; padding-left: 20px; color: #fff; font-family: Arial, sans-serif; font-size: 22px; }

#footerbar { padding-bottom: 20px; }
#footer { padding: 13px 40px 13px 20px; }

</style>
</head>
<body bgcolor="#ffffff">
<!-- InstanceBeginEditable name="body_top" --><!-- InstanceEndEditable -->
<a name="top"></a>
<div class="main">
  <div class="clear">
    <div class="dp20">
      <div id="logobar">
        <a href="http://goodingredients.org"><img src="../../../img/good-ingredients.png" class="noborder" alt="Good Ingredients" /></a>
      </div>
    </div>
    <div id="links" class="dp40">
      <div id="navcontainer">
        <ul>
          <li class="first"><a href="../../../index.html">Home</a></li>
          <li><a href="../../../ingredients/index.html">Ingredients</a></li>
          <li><a href="../index.html">Recipes</a></li>
        </ul>
      </div>
    </div>
    <div id="search" class="dp40">
      <form>
        <input type="text" value="Search site" /><input type="submit" value="Search" />
      </form>
    </div>
  </div>
</div>

<div class="main">
  <div id="linksbar" class="dp100">
    <h2>Good Server Infrastrucutre<h2>
  </div>
</div>
<div class="main">

<div id="content" class="dp100">
<div id="content_content">
<h1 class="heading">
<!-- InstanceBeginEditable name="heading" -->Spam and Virus Protection<!-- InstanceEndEditable -->
</h1>
<!-- InstanceBeginEditable name="breadcrumbs" -->
<!-- #BeginContextItem "../../../Context/breadcrumbs.cti" -->
<a href="../../index.html">Recipes</a> &gt;
<a href="../index.html">Core Recipes</a> &gt;
.. &gt;
Spam and Virus Protection
<!-- #EndContextItem -->
<!--  InstanceEndEditable -->
<!-- InstanceBeginEditable name="content" --><p>Some estimate calculate that spam averages 94% of all e-mail sent and without
good spam protection it can make up a significant proportion of a user's
emails.</p>
<p>Luckily there is good open-source spam protection software available and this
tutorial will show you how to use it.</p>
<div class="section" id="which-servers-to-place-the-protection-on">
<h2>Which Servers to Place the Protection On</h2>
<p>One of the problems with spam and virus protection is that it can be fairly
resource-intesnive as each mail has to be compared and rated against various
databases and factors. Whilst you could put the spam protection on the PLP A
and PLP B servers to filter out spam as soon as it reaches your servers, I
prefer to filter it on the main mail nodes such as mail A.</p>
</div>
<div class="section" id="install-amavisd-new-spamassassin-and-clamav">
<h2>Install amavisd-new, SpamAssassin, And ClamAV</h2>
<p>AMaViS is a mail virus scanner which you can tell Postfix to pipe emails
through. Amavis can then check the emails with spamassassin to check for spam
and clam AV to check for viruses.</p>
<p>Install the three programs like this:</p>
<pre class="literal-block">
$ sudo apt-get install amavisd-new spamassassin clamav clamav-daemon pax
</pre>
<p>Other tutorials suggest you need these too but I've never installed them:</p>
<pre class="literal-block">
$ sudo apt-get install zoo unzip bzip2 libnet-ph-perl libnet-snpp-perl libnet-telnet-perl nomarch lzop pax
</pre>
<p>Afterwards we must configure <tt class="docutils literal"><span class="pre">amavisd-new</span></tt>. The configuration is split up in various files which reside in the <tt class="docutils literal"><span class="pre">/etc/amavis/conf.d</span></tt> directory. Take a look at each of them to become familiar with the configuration. Most settings are fine, however we must modify three files.</p>
<p>First we must enable ClamAV and SpamAssassin in <tt class="docutils literal"><span class="pre">/etc/amavis/conf.d/15-content_filter_mode</span></tt> by uncommenting the <tt class="docutils literal"><span class="pre">&#64;bypass_virus_checks_maps</span></tt> and the <tt class="docutils literal"><span class="pre">&#64;bypass_spam_checks_maps</span></tt> lines:</p>
<p>The file should look like this:</p>
<pre class="literal-block">
use strict;

# You can modify this file to re-enable SPAM checking through spamassassin
# and to re-enable antivirus checking.

#
# Default antivirus checking mode
# Uncomment the two lines below to enable it back
#

&#64;bypass_virus_checks_maps = (
   \%bypass_virus_checks, \&#64;bypass_virus_checks_acl, \$bypass_virus_checks_re);


#
# Default SPAM checking mode
# Uncomment the two lines below to enable it back
#

&#64;bypass_spam_checks_maps = (
   \%bypass_spam_checks, \&#64;bypass_spam_checks_acl, \$bypass_spam_checks_re);

1;  # ensure a defined return
</pre>
<p>Now take a look at the spam and virus settings in <tt class="docutils literal"><span class="pre">/etc/amavis/conf.d/20-debian_defaults</span></tt>. There's no need to change anything if the default settings are ok for you. The file contains many explanations so there's no need to explain the settings here:</p>
<pre class="literal-block">
...
$QUARANTINEDIR = &quot;$MYHOME/virusmails&quot;;
$quarantine_subdir_levels = 1; # enable quarantine dir hashing

$log_recip_templ = undef;    # disable by-recipient level-0 log entries
$DO_SYSLOG = 1;              # log via syslogd (preferred)
$syslog_ident = 'amavis';    # syslog ident tag, prepended to all messages
$syslog_facility = 'mail';
$syslog_priority = 'debug';  # switch to info to drop debug output, etc

$enable_db = 1;              # enable use of BerkeleyDB/libdb (SNMP and nanny)
$enable_global_cache = 1;    # enable use of libdb-based cache if $enable_db=1

$inet_socket_port = 10024;   # default listening socket

$sa_spam_subject_tag = '***SPAM*** ';
$sa_tag_level_deflt  = 2.0;  # add spam info headers if at, or above that level
$sa_tag2_level_deflt = 6.31; # add 'spam detected' headers at that level
$sa_kill_level_deflt = 6.31; # triggers spam evasive actions
$sa_dsn_cutoff_level = 10;   # spam level beyond which a DSN is not sent
...
$final_virus_destiny      = D_DISCARD;  # (data not lost, see virus quarantine)
$final_banned_destiny     = D_BOUNCE;   # D_REJECT when front-end MTA
$final_spam_destiny       = D_BOUNCE;
$final_bad_header_destiny = D_PASS;     # False-positive prone (for spam)
...
</pre>
<p>Finally, edit <tt class="docutils literal"><span class="pre">/etc/amavis/conf.d/50-user</span></tt> and add the line <tt class="docutils literal"><span class="pre">$pax='pax';</span></tt> in the middle:</p>
<pre class="literal-block">
use strict;

#
# Place your configuration directives here.  They will override those in
# earlier files.
#
# See /usr/share/doc/amavisd-new/ for documentation and examples of
# the directives you can use in this file
#

$pax='pax';

#------------ Do not modify anything below this line -------------
1;  # ensure a defined return
</pre>
<p>Afterwards, run these commands to add the clamav user to the amavis group and to restart amavisd-new and ClamAV:</p>
<pre class="literal-block">
$ sudo adduser clamav amavis
$ sudo /etc/init.d/amavis restart
$ sudo /etc/init.d/clamav-daemon restart
$ sudo /etc/init.d/clamav-freshclam restart
</pre>
<div class="tip">
<p class="first admonition-title">Tip</p>
<p>You might get this error, I don't know how to fix it!</p>
<pre class="literal-block">
$ sudo /etc/init.d/clamav-daemon restart
Stopping ClamAV daemon: clamd.
Starting ClamAV daemon: clamd LibClamAV Warning: ***********************************************************
LibClamAV Warning: ***  This version of the ClamAV engine is outdated.     ***
LibClamAV Warning: *** DON'T PANIC! Read http://www.clamav.net/support/faq ***
LibClamAV Warning: ***********************************************************
.
</pre>
<p class="last">I think it will go away when the Debian team get to packaging the latest version in the volatile repository.</p>
</div>
<p>Now we have to configure Postfix to pipe incoming email through <tt class="docutils literal"><span class="pre">amavisd-new</span></tt>. Emails arrive to Postfix on port 25, it will send them to AMaViS on port 10024 (XXX and receive them on port 10025???)</p>
<pre class="literal-block">
$ sudo postconf -e 'content_filter = amavis:[127.0.0.1]:10024'
$ sudo postconf -e 'receive_override_options = no_address_mappings'
</pre>
<p>Afterwards append the following lines to <tt class="docutils literal"><span class="pre">/etc/postfix/master.cf</span></tt>:</p>
<pre class="literal-block">
...
amavis unix - - - - 2 smtp
        -o smtp_data_done_timeout=1200
        -o smtp_send_xforward_command=yes

127.0.0.1:10025 inet n - - - - smtpd
        -o content_filter=
        -o local_recipient_maps=
        -o relay_recipient_maps=
        -o smtpd_restriction_classes=
        -o smtpd_client_restrictions=
        -o smtpd_helo_restrictions=
        -o smtpd_sender_restrictions=
        -o smtpd_recipient_restrictions=permit_mynetworks,reject
        -o mynetworks=127.0.0.0/8
        -o strict_rfc821_envelopes=yes
        -o receive_override_options=no_unknown_recipient_checks,no_header_body_checks
        -o smtpd_bind_address=127.0.0.1
</pre>
<p>Then restart Postfix:</p>
<pre class="literal-block">
$ sudo /etc/init.d/postfix restart
</pre>
<div class="section" id="checking-the-setup">
<h3>Checking the Setup</h3>
<p>Now run:</p>
<pre class="literal-block">
$ sudo netstat -tap | grep master
tcp        0      0 *:smtp                  *:*                     LISTEN      4959/master
tcp        0      0 localhost.localdo:10025 *:*                     LISTEN      4959/master
$ sudo netstat -tap | grep amavis
tcp        0      0 localhost.localdo:10024 *:*                     LISTEN      3281/amavisd (maste
</pre>
<p>and you should see Postfix (master) listening on port 25 (smtp) and 10025, and amavisd-new on port 10024:</p>
<div class="tip">
<p class="first admonition-title">Tip</p>
<p>If you don't see the amavis server running check syslog:</p>
<pre class="literal-block">
sudo tail -f /var/log/syslog
</pre>
<p>If you see a line like this:</p>
<pre class="literal-block">
(!)Net::Server: 2009/05/18-18:38:38 Couldn't fork: [Cannot allocate memory]\n\n  at line 293 in file /usr/share/perl5/Net/Server.pm
</pre>
<p>it means you don't have enough free memory. Run <tt class="docutils literal"><span class="pre">free</span> <span class="pre">-m</span></tt> and look at the second line, <tt class="docutils literal"><span class="pre">free</span></tt> column to see how much memory is free.</p>
<p>If you are running OpenVZ, run:</p>
<pre class="literal-block">
$ sudo cat /proc/user_beancounters
</pre>
<p>If the right-most value for <tt class="docutils literal"><span class="pre">privvmpages</span></tt> is not 0 you need to allocate more privvmpages to the VE.</p>
<pre class="literal-block">
# vzctl set 2 --privvmpages  128536 --save
</pre>
<p class="last">Now restart the VE.</p>
</div>
</div>
</div>
<div class="section" id="install-razor-pyzor-and-configure-spamassassin">
<h2>Install Razor, Pyzor And Configure SpamAssassin</h2>
<p>Razor and Pyzor are spamfilters that use a collaborative filtering network. To install Razor and Pyzor, run</p>
<pre class="literal-block">
$ sudo apt-get install razor pyzor
</pre>
<p>Now we have to tell SpamAssassin to use these three programs. Edit
<tt class="docutils literal"><span class="pre">/etc/spamassassin/local.cf</span></tt> and add the following lines to it at the end:</p>
<pre class="literal-block">
...
#pyzor
use_pyzor 1
pyzor_path /usr/bin/pyzor

#razor
use_razor2 1
razor_config /etc/razor/razor-agent.conf

#bayes
use_bayes 1
use_bayes_rules 1
bayes_auto_learn 1
</pre>
<p>You can check your SpamAssassin configuration by executing:</p>
<pre class="literal-block">
$ spamassassin --lint
</pre>
<p>It shouldn't show any errors.</p>
<p>Restart <tt class="docutils literal"><span class="pre">amavisd-new</span></tt> afterwards:</p>
<pre class="literal-block">
$ sudo /etc/init.d/amavis restart
</pre>
<p>Now we update our SpamAssassin rulesets as follows:</p>
<pre class="literal-block">
$ sudo sa-update --no-gpg
</pre>
<p>This can take a minute or two.</p>
<p>Next we create a cron job so that the rulesets will be updated regularly. Run</p>
<pre class="literal-block">
$ sudo crontab -e
</pre>
<p>to open the cron job editor. Create the following cron job:</p>
<pre class="literal-block">
0 3 */2 * * /usr/bin/sa-update --no-gpg &amp;&gt; /dev/null
</pre>
<p>This will update the rulesets every second day at 3am from now on.</p>
</div>
<div class="section" id="testing-the-setup">
<h2>Testing the Setup</h2>
<p>With everything set up, try sending a test email through the system.</p>
</div><p class="text-right">(<a href="spam-and-virus-protection.rst">view source</a>)</p><!--  InstanceEndEditable -->
</div>
</div>
</div>

<div class="main">
  <div id="footerbar" class="dp100">
    <div id="footer" class="dp100">
      <p> 
        Copyright &copy; <a href="http://jimmyg.org">James Gardner</a> 2009. All Rights Reserved. 
        See the <a href="../../../disclaimer.html">Disclaimer</a>. <br />
        <a href="http://3aims.com/contact.html">Contact</a> | 
        <a href="http://validator.w3.org/check?uri=referer" title="Validate this page for XHTML 1.0 Strict compliance">XHTML &amp; CSS</a>
      </p> 
    </div>
  </div>
</div>
</body>
<!-- InstanceEnd --></html>
