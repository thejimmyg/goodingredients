<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><!-- InstanceBegin template="../../../Templates/jimmyg.dwt" codeOutsideHTMLIsLocked="false" -->
<head>
<!-- InstanceBeginEditable name="doctitle" --><title>Testing Mail Servers</title><!-- InstanceEndEditable --> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<!-- InstanceBeginEditable name="meta" -->
<meta name="description" content="3aims Web Development, a Knowledge Interaction Technology consultancy based in London and specialising in Python" />
<meta name="keywords" content="3aims Python Pylons Web Development Programming NHS Consultancy Database" />
<!--  InstanceEndEditable -->
<!-- InstanceBeginEditable name="head" --><!--  InstanceEndEditable -->
<style type="text/css">
html, body, div, p { margin: 0; padding: 0; border: 0; }
body { background: #213502; font-family: Arial, Georgia, serif; color: #333; font-size: 14px; line-height: 145%; }
.main { /* margin:0 auto; */ width: 90%; }
.dp20,
.dp25,
.dp33,
.dp40,
.dp50,
.dp75,
.dp80,
.dp100{float:left; display: inline; *margin-left:-0.04em; } /* IE margin hack */
.dp20{width:20%;}
.dp25{width:25%;}
.dp33{width:33.33%;}
.dp40{width:40%;}
.dp50{width:50%;}
.dp80{width:80%;}
.dp75{width:75%;}
.dp100{width:100%;}
.clear{ clear:both; overflow: auto; width: 100%; }
.noborder{border: 0px;}
#logobar { height: 68px; padding-top: 16px; padding-left: 20px; }
#links { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; padding-top: 49px; }
#links a:link, #links a:visited, #links a:hover { color: #fff; text-decoration: none; }
#links a:hover { color: #fff; text-decoration: underline; }
#footer a:link, #footer a:visited, #footer a:hover { color: #fff; text-decoration: underline; }
#footer p { color: #fff }
#search { text-align: right; }
#search form { padding-top: 15px; margin: 0px; }

#content { background: #fff; margin-top: 5px; margin-bottom: 10px;}
#content_content { padding: 20px; padding-right: 40px; }

#navcontainer ul { margin: 0; padding: 0; list-style-type: none; } 
#navcontainer ul li { display: inline; }
#navcontainer ul li a { text-decoration: none; padding: .2em .55em; }
#navcontainer ul li.first a { padding: .2em .55em .2em 0; }
#navcontainer ul li.highlight a { color: #fcff02; background: #008cca; }
h1 { font-family: Arial, serif; font-weight: normal; font-size: 26px; }
h2 { font-weight: normal; font-size: 22px;}
p { color: #333; }
li.norm { color: #333; }
p.large { font-size: 16px; }
p { padding-top: 15px; }
p.first { padding-top: 0px; }
li.norm a, li.norm a:visited, li.norm a:link, p a, p a:visited, p a:link { color: #3883a9 ; }
p a:hover { color: #58aecb; }

pre { overflow:auto; border-top: 1px solid #71ae1b; border-bottom: 1px solid #71ae1b; background: #e0f8bf; padding: 3px; font-size: 13px; margin-bottom: 0px; line-height: 130%; }
table { margin-top: 15px; }
#linksbar { background: #71ae1b;  border-bottom: 1px solid #9ddb44; border-top: 3px solid #142200; padding: 13px 0 13px 0; }
#linksbar h2 { padding: 0px; margin: 0px; padding-left: 20px; color: #fff; font-family: Arial, sans-serif; font-size: 22px; }

#footerbar { padding-bottom: 20px; }
#footer { padding: 13px 40px 13px 20px; }

</style>
</head>
<body bgcolor="#ffffff">
<!-- InstanceBeginEditable name="body_top" --><!-- InstanceEndEditable -->
<a name="top"></a>
<div class="main">
  <div class="clear">
    <div class="dp20">
      <div id="logobar">
        <a href="http://goodingredients.org"><img src="../../../img/good-ingredients.png" class="noborder" alt="Good Ingredients" /></a>
      </div>
    </div>
    <div id="links" class="dp40">
      <div id="navcontainer">
        <ul>
          <li class="first"><a href="../../../index.html">Home</a></li>
          <li><a href="../../../ingredients/index.html">Ingredients</a></li>
          <li><a href="../index.html">Recipes</a></li>
        </ul>
      </div>
    </div>
    <div id="search" class="dp40">
      <form>
        <input type="text" value="Search site" /><input type="submit" value="Search" />
      </form>
    </div>
  </div>
</div>

<div class="main">
  <div id="linksbar" class="dp100">
    <h2>Good Server Infrastrucutre<h2>
  </div>
</div>
<div class="main">

<div id="content" class="dp100">
<div id="content_content">
<h1 class="heading">
<!-- InstanceBeginEditable name="heading" -->Testing Mail Servers<!-- InstanceEndEditable -->
</h1>
<!-- InstanceBeginEditable name="breadcrumbs" -->
<!-- #BeginContextItem "../../../Context/breadcrumbs.cti" -->
<a href="../../index.html">Recipes</a> &gt;
<a href="../index.html">Core Recipes</a> &gt;
.. &gt;
Testing Mail Servers
<!-- #EndContextItem -->
<!--  InstanceEndEditable -->
<!-- InstanceBeginEditable name="content" --><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#testing-unauthenticated-unencrypted-smtp" id="id1">Testing Unauthenticated, Unencrypted SMTP</a><ul>
<li><a class="reference internal" href="#from-localhost" id="id2">From localhost</a></li>
<li><a class="reference internal" href="#from-a-remote-machine-to-a-known-address" id="id3">From a Remote Machine to a Known Address</a></li>
<li><a class="reference internal" href="#from-a-remote-machine-to-an-unknown-address" id="id4">From a Remote Machine to an Unknown Address</a></li>
</ul>
</li>
<li><a class="reference internal" href="#understanding-authentication" id="id5">Understanding Authentication</a><ul>
<li><a class="reference internal" href="#sasl" id="id6">SASL</a></li>
<li><a class="reference internal" href="#enabling-and-disabling-unencypted-authentication-in-postfix" id="id7">Enabling and Disabling Unencypted Authentication in Postfix</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing-plain-authenticated-unencrypted-smtp" id="id8">Testing PLAIN Authenticated, Unencrypted SMTP</a></li>
<li><a class="reference internal" href="#testing-login-authenticated-unencrypted-smtp" id="id9">Testing LOGIN Authenticated, Unencrypted SMTP</a></li>
<li><a class="reference internal" href="#understanding-encryption" id="id10">Understanding Encryption</a><ul>
<li><a class="reference internal" href="#checking-if-a-server-supports-tls" id="id11">Checking if a server supports TLS</a></li>
<li><a class="reference internal" href="#connecting-to-different-configurations-of-smtp-server" id="id12">Connecting to Different Configurations of SMTP Server</a></li>
<li><a class="reference internal" href="#connecting-to-a-server-using-encryption" id="id13">Connecting to a Server using Encryption</a></li>
</ul>
</li>
</ul>
</div>
<p>Over the last couple of weeks I've designing a mail infrastructure for a
production system. As part of the implementation I wanted to be able to test
all the settings from the command line to make sure everything was working. In
this document I'll explain the different options you can have and how to test
them.</p>
<div class="section" id="testing-unauthenticated-unencrypted-smtp">
<h2><a class="toc-backref" href="#id1">Testing Unauthenticated, Unencrypted SMTP</a></h2>
<p>In a correct setup this should only work when you connect from the same server
which is running the SMTP server. It it works from a remote computer then the
server is an <em>open relay</em> which means spammers can use your server to send
their spam. This will result in your server quickly becoming blacklisted and
after that you'll find that many legitimate e-mails you send from it will be
marked as spam in the recipient's inboxes.</p>
<div class="section" id="from-localhost">
<h3><a class="toc-backref" href="#id2">From localhost</a></h3>
<p>First try from the local machine:</p>
<pre class="literal-block">
$ telnet localhost smtp
</pre>
<p>Here's what you type:</p>
<pre class="literal-block">
ehlo plpb.example.com
mail from:&lt;james&#64;example.org&gt;
rcpt to:&lt;james&#64;example.com&gt;
data
Hi James

This is a test message, testing sending mail via unencrypted SMTP
from the same machine as the SMTP server without logging in.

James
.
</pre>
<p>Make sure the address in the <tt class="docutils literal"><span class="pre">rcpt</span> <span class="pre">to</span></tt> line isn't one that is used by email
addresses hosted by the local machine because it should accept these anyway.
Also you must press Enter after the dot on its own. Since you connected from a
local machine this should work.</p>
<p>Here's the complete output when I ran this test:</p>
<pre class="literal-block">
220 plpb.example.com ESMTP Postfix (Debian/GNU)
ehlo plpb.example.com
250-plpb.example.com
250-PIPELINING
250-SIZE 30720000
250-VRFY
250-ETRN
250-STARTTLS
250-AUTH PLAIN LOGIN
250-AUTH=PLAIN LOGIN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250 DSN
mail from:&lt;james&#64;example.org&gt;
250 2.1.0 Ok
rcpt to:&lt;james&#64;example.com&gt;
250 2.1.5 Ok
data
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
Hi James

This is a test message, testing sending mail via unencrypted SMTP
from the same machine as the SMTP server without logging in.

James
.
250 2.0.0 Ok: queued as 217083C8C1
</pre>
<p>Once the message is queued type <tt class="docutils literal"><span class="pre">quit</span></tt> to exit telnet. In a few seconds the
email should arrive in your inbox.</p>
<div class="tip">
<p class="first admonition-title">Tip</p>
<p>If you are running this from a local virtual machine for test purposes there
is a chance your ISP, like mine seems to have blocked DNS lookups so you'll see
an error like this in <tt class="docutils literal"><span class="pre">/var/log/syslog</span></tt>:</p>
<pre class="literal-block">
May 24 13:14:07 plpb postfix/smtp[706]: 217083C8C1: to=&lt;james&#64;example.com&gt;,
relay=none, delay=419, delays=399/0.11/20/0, dsn=4.4.3, status=deferred
(Host or domain name not found. Name service error for name=example.com
type=MX: Host not found, try again)
</pre>
<p class="last">It would probably work in real life though.</p>
</div>
</div>
<div class="section" id="from-a-remote-machine-to-a-known-address">
<h3><a class="toc-backref" href="#id3">From a Remote Machine to a Known Address</a></h3>
<p>Now try the same but from another machine. You should run two tests, one with a
<tt class="docutils literal"><span class="pre">rcpt</span> <span class="pre">to</span></tt> line containing an email address hosted by the mail server and one
containing an external email address. You should find you are able to send any
emails destined for addresses the mail server hosts (otherwise you'd never be
able to recieve mail from the outside world either) but that you get an error
after specifying an address in the <tt class="docutils literal"><span class="pre">rcpt</span> <span class="pre">to</span></tt> line which isn't one of the
domains hosted by the mail server.</p>
<p>First let's try an email from a remote machine to a known address:</p>
<pre class="literal-block">
$ telnet plpb.example.com smtp
</pre>
<p>Here's what you type:</p>
<pre class="literal-block">
ehlo plpb.example.com
mail from:&lt;james&#64;example.org&gt;
rcpt to:&lt;james&#64;new.example.com&gt;
data
Hi James

This is a test message, testing sending mail via unencrypted SMTP
from a remote machine to a known address on the SMTP server
without logging in.

James
.
</pre>
<p>Here's the output of the conversation:</p>
<pre class="literal-block">
220 plpb.example.com ESMTP Postfix (Debian/GNU)
ehlo plpb.example.com
250-plpb.example.com
250-PIPELINING
250-SIZE 30720000
250-VRFY
250-ETRN
250-STARTTLS
250-AUTH PLAIN LOGIN
250-AUTH=PLAIN LOGIN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250 DSN
mail from:&lt;james&#64;example.org&gt;
250 2.1.0 Ok
rcpt to:&lt;james&#64;new.example.com&gt;
250 2.1.5 Ok
data
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
Hi James
This is a test message, testing sending mail via unencrypted SMTP
from a remote machine to a known address on the SMTP server
without logging in.

James
.
250 2.0.0 Ok: queued as 5F5743C8C2
</pre>
<p>The mail gets sent successfully.</p>
</div>
<div class="section" id="from-a-remote-machine-to-an-unknown-address">
<h3><a class="toc-backref" href="#id4">From a Remote Machine to an Unknown Address</a></h3>
<p>Now try from a remote machine to an <strong>unknown</strong> address:</p>
<pre class="literal-block">
$ telnet plpb.example.com smtp
</pre>
<p>Here's what you type:</p>
<pre class="literal-block">
ehlo plpb.example.com
mail from:&lt;james&#64;example.org&gt;
rcpt to:&lt;james&#64;example.com&gt;
</pre>
<p>You won't be able to get any further than this because you'll get a <tt class="docutils literal"><span class="pre">Relay</span>
<span class="pre">access</span> <span class="pre">denied</span></tt> error.</p>
<p>Here's the output of the conversation:</p>
<pre class="literal-block">
ehlo plpb.example.com
250-plpb.example.com
250-PIPELINING
250-SIZE 30720000
250-VRFY
250-ETRN
250-STARTTLS
250-AUTH PLAIN LOGIN
250-AUTH=PLAIN LOGIN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250 DSN
mail from:&lt;james&#64;example.org&gt;
250 2.1.0 Ok
rcpt to:&lt;james&#64;example.com&gt;
554 5.7.1 &lt;james&#64;example.com&gt;: Relay access denied
</pre>
<p>This is correct behaviour and means your server is not an open relay. To be
able to send emails to unknown addresses you need to login. Let's look at this
next.</p>
</div>
</div>
<div class="section" id="understanding-authentication">
<h2><a class="toc-backref" href="#id5">Understanding Authentication</a></h2>
<p>To enable users who aren't running mail clients on the same machine as the SMTP
server to send email you have to let them login. There are various different
ways a user can send login information to the SMTP server including PLAIN and
LOGIN. The same login mechanisms can be used on an encrypted or unencrypted
connection so don't assume that just because you are logging into the server,
that the connection is secure.</p>
<p>To see if the SMTP server you are connecting to supports authentication, and to
find out what authentication it supports, you should look for this line in the
output which is returned after you've sent the <tt class="docutils literal"><span class="pre">ehlo</span></tt> line:</p>
<pre class="literal-block">
250-AUTH PLAIN LOGIN
</pre>
<p>Some servers will also send this second line so that broken clients like
Outlook Express 4 can understand that the server supports SMTP AUTH:</p>
<pre class="literal-block">
250-AUTH=PLAIN LOGIN
</pre>
<p>Either way, this tells you that the SMTP server supports authentication and that it
supports the PLAIN and LOGIN authentication methods. Neither of these methods
are secure unless you are using an encrypted connection. There are other
methods too like CRAM-MD5 or DIGEST-MD5 which prevent someone listenting from
viewing the password in plain text, but anyone listening in on the connection
can simply send the same information to pretend to be the user so there is
really very little benefit to them and lot's of servers don't use them. Instead
if you want security between the mail client and the SMTP server you use an
encrypted connection and in that case you can just send the username in plain
text anyway because the connection is secure.</p>
<div class="section" id="sasl">
<h3><a class="toc-backref" href="#id6">SASL</a></h3>
<p>Behind the scenes, it is very likely that the SMTP server will use the <a class="reference external" href="http://www.ietf.org/rfc/rfc2222.txt">Simple
Authentication and Security Layer (SASL)</a> to check the username and password
(using whichever format they are supplied in). It is possible that an IMAP or
POP3 server running for the same mailboxes will also use SASL for its
authentication and that means users can share the same login details for all
their mail services and it means sysadmins have less work to do managing the
accounts. SASL isn't any sort of protocol the clients will use, it is just
something that goes on behind the scenes on the mail server.</p>
</div>
<div class="section" id="enabling-and-disabling-unencypted-authentication-in-postfix">
<h3><a class="toc-backref" href="#id7">Enabling and Disabling Unencypted Authentication in Postfix</a></h3>
<p>If you are using Postfix in the way described in my other articles SMTP
authentication over an unencypted connection is disabled because it is not
secure. For testing though you can allow it by running this command:</p>
<pre class="literal-block">
$ sudo postconf -e smtpd_tls_auth_only=no
</pre>
<p>and then restarting Postfix:</p>
<pre class="literal-block">
$ sudo /etc/init.d/postfix restart
</pre>
<p>Afterwards, set it back like this:</p>
<pre class="literal-block">
$ sudo postconf -e smtpd_tls_auth_only=yes
</pre>
</div>
</div>
<div class="section" id="testing-plain-authenticated-unencrypted-smtp">
<h2><a class="toc-backref" href="#id8">Testing PLAIN Authenticated, Unencrypted SMTP</a></h2>
<div class="note">
<p class="first admonition-title">Note</p>
<p>If you are using my set up, the PLP A and PLP B servers do not support sending
emails so this won't work on them, you'll just get one of these errors:</p>
<pre class="literal-block">
535 5.7.8 Error: authentication failed: authentication failure
535 5.7.8 Error: authentication failed: bad protocol / cancel
</pre>
<p class="last">Instead you should test the maila server.</p>
</div>
<p>Using PLAIN authentication, the username and password have to be sent as a
single string which is Base 64 encoded. The unencoded string looks like this
with <tt class="docutils literal"><span class="pre">\0</span></tt> characters at the start and between the username
and password:</p>
<pre class="literal-block">
\0username\0yourpassword
</pre>
<p>It is common to use the email address itself as the username so this is what
we'll do in these examples. You can generate the base64 version of the string
using <tt class="docutils literal"><span class="pre">mmencode</span></tt> and use it like this without needing to escape any other
characters:</p>
<pre class="literal-block">
$ echo -ne '\0james&#64;new.example.com\0yourpassword' | mmencode
AGphbWVzQG5ldy5leGFtcGxlLmNvbQB5b3VycGFzc3dvcmQ=
</pre>
<p>If you don't have <tt class="docutils literal"><span class="pre">mmencode</span></tt> installed you can use <tt class="docutils literal"><span class="pre">openssl</span></tt>:</p>
<pre class="literal-block">
$ echo -ne '\0james&#64;new.example.com\0yourpassword' | openssl enc -base64
AGphbWVzQG5ldy5leGFtcGxlLmNvbQB5b3VycGFzc3dvcmQ=
</pre>
<p>Or Perl, (with some escaping):</p>
<pre class="literal-block">
$ perl -MMIME::Base64 -e 'print encode_base64(&quot;\000james\&#64;new.example.com\000yourpassword&quot;)'
AGphbWVzQG5ldy5leGFtcGxlLmNvbQB5b3VycGFzc3dvcmQ=
</pre>
<div class="tip">
<p class="first admonition-title">Tip</p>
<p>Just remember that just because the username and password are encoded, they
are still easy for an eavesdropper to read. If you just change &quot;encode_base64&quot;
to &quot;decode_base64&quot; in the perl example you'll see just how easy this is (the
<tt class="docutils literal"><span class="pre">\0</span></tt> characters aren't shown):</p>
<pre class="last literal-block">
$ perl -MMIME::Base64 -e 'print decode_base64(&quot;AGphbWVzQG5ldy5leGFtcGxlLmNvbQB5b3VycGFzc3dvcmQ=&quot;);'
james&#64;new.example.comyourpassword
</pre>
</div>
<p>Let's test PLAIN authentication. From a remote machine:</p>
<pre class="literal-block">
$ telnet maila.example.com smtp
</pre>
<p>Here's what you type, replacing the base 64 encoded string with the correct
version for your username and password:</p>
<pre class="literal-block">
ehlo maila.example.com
AUTH PLAIN AGphbWVzQG5ldy5leGFtcGxlLmNvbQB5b3VycGFzc3dvcmQ=
mail from:&lt;james&#64;example.org&gt;
rcpt to:&lt;james&#64;example.com&gt;
data
Hi James

This is a test message, testing sending mail via unencrypted SMTP
from a remote machine using AUTH PLAIN to an unknown address.

James
.
</pre>
<p>Once again you must press Enter after the dot on its own line and you should
test with an email address not on the local machine to check it will now send
out emails if you are authenticated.</p>
<p>If the authentication information isn't correct you'll see this line:</p>
<pre class="literal-block">
535 5.7.8 Error: authentication failed:
</pre>
<p>If you have set up not to allow unencrypted signins you'll see this:</p>
<pre class="literal-block">
504 5.5.4 Encryption required for requested authentication mechanism
</pre>
<p>See the previouse section for how to enable/disable unencypted logins in Postfix. Otherwise you'll see:</p>
<pre class="literal-block">
235 2.7.0 Authentication successful
</pre>
<p>Here's the full conversation once you've authenticated correctly:</p>
<pre class="literal-block">
ehlo maila.example.com
220 maila.example.com ESMTP Postfix (Debian/GNU)
250-maila.example.com
250-PIPELINING
250-SIZE 30720000
250-VRFY
250-ETRN
250-STARTTLS
250-AUTH PLAIN LOGIN
250-AUTH=PLAIN LOGIN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250 DSN
AUTH PLAIN AGphbWVzQG5ldy5leGFtcGxlLmNvbQB5b3VycGFzc3dvcmQ=
235 2.7.0 Authentication successful
mail from:&lt;james&#64;example.org&gt;
250 2.1.0 Ok
rcpt to:&lt;james&#64;example.com&gt;
250 2.1.5 Ok
data
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
Hi James

This is a test message, testing sending mail via unencrypted SMTP
from a remote machine using AUTH PLAIN to an unknown address.

James
.
250 2.0.0 Ok: queued as 14DC0471C
</pre>
</div>
<div class="section" id="testing-login-authenticated-unencrypted-smtp">
<h2><a class="toc-backref" href="#id9">Testing LOGIN Authenticated, Unencrypted SMTP</a></h2>
<p>LOGIN authentication happens in a very similar way but the username and
password are sent separately. First let's base 64 encode the username and
password:</p>
<pre class="literal-block">
$ echo -ne 'james&#64;new.example.com' | openssl enc -base64
amFtZXNAbmV3LjNhaW1zLmNvbQ==
$ echo -ne 'yourpassword' | openssl enc -base64
cGFzc3dvcmQ=
</pre>
<p>Let's test it. Again, from a remote machine:</p>
<pre class="literal-block">
$ telent maila.example.com smtp
</pre>
<p>Here's what you type, replacing the base 64 encoded string with the correct
version for your username and password:</p>
<pre class="literal-block">
ehlo maila.example.com
AUTH LOGIN
amFtZXNAbmV3LjNhaW1zLmNvbQ==
cGFzc3dvcmQ=
mail from:&lt;james&#64;example.org&gt;
rcpt to:&lt;james&#64;example.com&gt;
data
Hi James

This is a test message, testing sending mail via unencrypted SMTP
from a remote machine using AUTH LOGIN to an unknown address.

James
.
</pre>
<p>Here's the entire conversation:</p>
<pre class="literal-block">
ehlo maila.example.com
220 maila.example.com ESMTP Postfix (Debian/GNU)
250-maila.example.com
250-PIPELINING
250-SIZE 30720000
250-VRFY
250-ETRN
250-STARTTLS
250-AUTH PLAIN LOGIN
250-AUTH=PLAIN LOGIN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250 DSN
AUTH LOGIN
334 VXNlcm5hbWU6
amFtZXNAbmV3LjNhaW1zLmNvbQ==
334 UGFzc3dvcmQ6
cGFzc3dvcmQ=
235 2.7.0 Authentication successful
mail from:&lt;james&#64;example.org&gt;
250 2.1.0 Ok
rcpt to:&lt;james&#64;example.com&gt;
250 2.1.5 Ok
data
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
Hi James

This is a test message, testing sending mail via unencrypted SMTP
from a remote machine using AUTH LOGIN to an unknown address.

James
.
250 2.0.0 Ok: queued as D9138471
</pre>
<p>At this point remember to turn unencrypted auth login off if you enabled it for
the tests:</p>
<pre class="literal-block">
$ sudo postconf -e smtpd_tls_auth_only=yes
$ sudo /etc/init.d/postfix restart
</pre>
</div>
<div class="section" id="understanding-encryption">
<h2><a class="toc-backref" href="#id10">Understanding Encryption</a></h2>
<p>As well as having a plain text conversation like all the examples so far, it is
possible to encrypt the converstation between the client and the SMTP server.
Of course, this doesn't mean that the message it self is encrypted for the rest
of its journey to the recipient, just that it is encrypted until it reaches the
server.</p>
<p>There are three main ways to encrypt the conversation:</p>
<ul class="simple">
<li>SSL</li>
<li>TLS</li>
<li>STARTTLS</li>
</ul>
<p>Secure Sockets Layer (SSL) is the predecessor of Transport Layer Security (TLS)
so we won't consider it further. TLS is a cryptographic protocol that provide
security and data integrity for communications over a network. Using TLS, every
part of the SMTP conversation is encrypted. The one problem with this is that
clients which don't support TLS won't understand any part of the conversation
and won't be able to drop down to a less secure method if it is allowed. To
solve this problem the <tt class="docutils literal"><span class="pre">STARTTLS</span></tt> command was introduced. This allows a
client to issue the <tt class="docutils literal"><span class="pre">ehlo</span></tt> command in plain text and then use a secure
connection from then on if both the client and the server support it.</p>
<div class="section" id="checking-if-a-server-supports-tls">
<h3><a class="toc-backref" href="#id11">Checking if a server supports TLS</a></h3>
<p>To check if a server supports TLS you need to look at the output after the
<tt class="docutils literal"><span class="pre">ehlo</span></tt> command. If it conatins this line then TLS is supported:</p>
<pre class="literal-block">
250-STARTTLS
</pre>
</div>
<div class="section" id="connecting-to-different-configurations-of-smtp-server">
<h3><a class="toc-backref" href="#id12">Connecting to Different Configurations of SMTP Server</a></h3>
<p>You can configure your SMTP servers in a number of different ways:</p>
<ul class="simple">
<li>Unencrypted</li>
<li>SSL only</li>
<li>TLS only</li>
<li>Unencrypted initially then TLS via the <tt class="docutils literal"><span class="pre">STARTTLS</span></tt> command</li>
</ul>
<p>Most people would use the last option but with that in mind you'll need to know
the different ways you can connect to the different types of SMTP service.</p>
<p>On Postfix, this is configured by specifying <tt class="docutils literal"><span class="pre">smtpd_tls_security_level</span> <span class="pre">=</span>
<span class="pre">may</span></tt>. There is more information on <a class="reference external" href="http://www.postfix.org/TLS_README.html">Postfix TLS here</a>.</p>
</div>
<div class="section" id="connecting-to-a-server-using-encryption">
<h3><a class="toc-backref" href="#id13">Connecting to a Server using Encryption</a></h3>
<p>To connect to a non-secured SMTP server you would use this command as we have
been doing so far:</p>
<pre class="literal-block">
$ telnet maila.example.com smtp
</pre>
<p>To connect to a server which should support TLS you can use the <tt class="docutils literal"><span class="pre">-starttls</span>
<span class="pre">smtp</span></tt> option of <tt class="docutils literal"><span class="pre">openssl</span> <span class="pre">s_client</span></tt> to connect. This makes <tt class="docutils literal"><span class="pre">openssl</span></tt>
connect normally (without encryption), send a <tt class="docutils literal"><span class="pre">STARTTLS</span></tt> command, negotiate
the SSL encryption, and then allow you to interact with the encrypted session.</p>
<p>Here's the command:</p>
<pre class="literal-block">
$ openssl s_client -starttls smtp -crlf -connect maila.example.com:25
</pre>
<p>For an SSL server where you connect to a different port number and have to
establish an SSL connection before the SMTP conversation you use this
command:</p>
<pre class="literal-block">
$ openssl s_client -crlf -connect maila.example.com:465
</pre>
<p>Everything that worked before should work with the two encryped methods except
now, even if you have AUTH logins disabled for non-encrypted connections, you
should be able to connect.</p>
<p>Let's try. Connect like this:</p>
<pre class="literal-block">
$ openssl s_client -starttls smtp -crlf -connect maila.example.com:25
</pre>
<p>Enter the following commands for PLAIN login:</p>
<pre class="literal-block">
ehlo maila.example.com
AUTH PLAIN AGphbWVzQG5ldy5leGFtcGxlLmNvbQB5b3VycGFzc3dvcmQ=
mail from:&lt;james&#64;example.org&gt;
rcpt to:&lt;james&#64;example.com&gt;
data
Hi James

This is a test message, testing sending mail via TLS
from a remote machine using AUTH PLAIN to an unknown address.

James
.
</pre>
<p>Here's the actual output including the exchange of certificates:</p>
<pre class="literal-block">
CONNECTED(00000003)
depth=0 /C=GB/ST=Some-State/L=London/O=Internet Widgits Pty Ltd/CN=maila.example.com
verify error:num=18:self signed certificate
verify return:1
depth=0 /C=GB/ST=Some-State/L=London/O=Internet Widgits Pty Ltd/CN=maila.example.com
verify return:1
---
Certificate chain
 0 s:/C=GB/ST=Some-State/L=London/O=Internet Widgits Pty Ltd/CN=maila.example.com
   i:/C=GB/ST=Some-State/L=London/O=Internet Widgits Pty Ltd/CN=maila.example.com
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIEOTCCAyGgAwIBAgIJAJIjOLPDIOagMA0GCSqGSIb3DQEBBQUAMHAxCzAJBgNV
BAYTAkdCMRMwEQYDVQQIEwpTb21lLVN0YXRlMQ8wDQYDVQQHEwZMb25kb24xITAf
BgNVBAoTGEludGVybmV0IFdpZGdpdHMgUHR5IEx0ZDEYMBYGA1UEAxMPbWFpbGEu
M2FpbXMuY29tMB4XDTA5MDUxNzIwMzQ1M1oXDTEwMDUxNzIwMzQ1M1owcDELMAkG
A1UEBhMCR0IxEzARBgNVBAgTClNvbWUtU3RhdGUxDzANBgNVBAcTBkxvbmRvbjEh
MB8GA1UEChMYSW50ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMRgwFgYDVQQDEw9tYWls
YS4zYWltcy5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCVy+XL
mASmNS1XAGHIz+ZpDZYCLIZeVpMySYxctcMBbfuM/LixEbQi0pBPHnb82vqK82bg
dp/CQNch/HzHm9w+2bImdiRq7HJX5T4re+709Ts4FXQetDcsGUBRXTicIydFzS5h
oOldK5o+gwQvA9LKbZAYuwkjXPcWWW5A+43FwnuU6i+42Ycc8NZWuz1VepSEArnS
NNJZjePQHakcj4BGza8GzVkT5suAPY/WAobzW49nDCmHs2cEBaAGIXdAnJKtz3YL
sn9hzcDKDNaf9yHIjHMgoVFFEKUDMvXwkCnXRoWZPcl2fBA60ZxCn5YjjjwT6bf7
Rx/RKwUcBI3mmbJ5AgMBAAGjgdUwgdIwHQYDVR0OBBYEFG7Ebxv/kXiwEnsHAuQm
XiyKk7WGMIGiBgNVHSMEgZowgZeAFG7Ebxv/kXiwEnsHAuQmXiyKk7WGoXSkcjBw
MQswCQYDVQQGEwJHQjETMBEGA1UECBMKU29tZS1TdGF0ZTEPMA0GA1UEBxMGTG9u
ZG9uMSEwHwYDVQQKExhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQxGDAWBgNVBAMT
D21haWxhLjNhaW1zLmNvbYIJAJIjOLPDIOagMAwGA1UdEwQFMAMBAf8wDQYJKoZI
hvcNAQEFBQADggEBAEi9yk42XERQdnoSf6g1iSwD32flexx3M6xQvBj2IBRIfS1k
8q23docVdLLAT8O86bcPBAN6tTPhDbYUwfWdo/cEpyaRpEpX18r6LXETk4GsWVFM
VghjI4gTnNEuKGMWDvvafoLsGnUP8k31M6rvnPhQ62Zh/nsObRaLiLxUe7FQGHOM
pqJoMRorigWr9KUw9vBz9znuGEokXpBPQHWLlSIQQIRbVkni0Pol6LkcHg7pxY20
BpIdQQtxhCgEE1pZKECai1GAtBiDJq2XXlo+znzMwpI3008yBlRv+UZrGnmKnSsJ
wO430I0cPgbtQ6HL4i1HriSD8W28Q1G9sni6wwE=
-----END CERTIFICATE-----
subject=/C=GB/ST=Some-State/L=London/O=Internet Widgits Pty Ltd/CN=maila.example.com
issuer=/C=GB/ST=Some-State/L=London/O=Internet Widgits Pty Ltd/CN=maila.example.com
---
No client certificate CA names sent
---
SSL handshake has read 2037 bytes and written 351 bytes
---
New, TLSv1/SSLv3, Cipher is DHE-RSA-AES256-SHA
Server public key is 2048 bit
Compression: NONE
Expansion: NONE
SSL-Session:
    Protocol  : TLSv1
    Cipher    : DHE-RSA-AES256-SHA
    Session-ID: CC8A68A907FA72CF875D9F91995BD1E1DA43F61A1C1760A3EE01516312455FE7
    Session-ID-ctx:
    Master-Key: FFE8EE71CA8370CCB3A8925859B709AADDB034CEBB0C45F45F4D019798E4A766C8EBBDDF0C59269C8023AB062C4D2E18
    Key-Arg   : None
    Start Time: 1243178088
    Timeout   : 300 (sec)
    Verify return code: 18 (self signed certificate)
---
250 DSN
AUTH PLAIN AGphbWVzQG5ldy5leGFtcGxlLmNvbQB5b3VycGFzc3dvcmQ=
235 2.7.0 Authentication successful
mail from:&lt;james&#64;example.org&gt;
250 2.1.0 Ok
rcpt to:&lt;james&#64;example.com&gt;
250 2.1.5 Ok
data
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
Hi James

This is a test message, testing sending mail via TLS
from a remote machine using AUTH PLAIN to an unknown address.

James
.
250 2.0.0 Ok: queued as 9E986471C
</pre>
</div>
</div><p class="text-right">(<a href="smtp-testing.rst">view source</a>)</p><!--  InstanceEndEditable -->
</div>
</div>
</div>

<div class="main">
  <div id="footerbar" class="dp100">
    <div id="footer" class="dp100">
      <p> 
        Copyright &copy; <a href="http://jimmyg.org">James Gardner</a> 2009. All Rights Reserved. 
        See the <a href="../../../disclaimer.html">Disclaimer</a>. <br />
        <a href="http://3aims.com/contact.html">Contact</a> | 
        <a href="http://validator.w3.org/check?uri=referer" title="Validate this page for XHTML 1.0 Strict compliance">XHTML &amp; CSS</a>
      </p> 
    </div>
  </div>
</div>
</body>
<!-- InstanceEnd --></html>
